<% content_for :title, "Settings" %>

<div class="max-w-6xl mx-auto">
  <% if notice.present? %>
    <div class="mb-6 py-3 px-4 bg-green-500/10 border border-green-500/20 text-green-400 rounded-lg">
      <%= notice %>
    </div>
  <% end %>

  <div class="mb-8">
    <h1 class="text-2xl font-bold text-white mb-2">Settings</h1>
    <p class="text-slate-400">Manage homepage content and integrations.</p>
  </div>

  <!-- Header Section Form -->
  <%= form_with url: batch_update_admin_settings_path, method: :patch, multipart: true, class: "mb-6" do |f| %>
    <div class="bg-surface-dark rounded-xl border border-slate-700/50 overflow-hidden">
      <div class="p-6 border-b border-slate-700/50">
        <h2 class="text-lg font-bold text-white flex items-center gap-2">
          <span class="material-symbols-outlined text-primary">web</span>
          Header
        </h2>
      </div>
      <div class="p-6 space-y-4">
        <!-- Logo Upload -->
        <% logo_setting = Setting.logo %>
        <div>
          <%= label_tag :site_logo, "Site Logo (Upload Image)", class: "block text-sm font-medium text-slate-300 mb-2" %>
          <%= file_field_tag :site_logo, accept: "image/*", class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-blue-600" %>
          <p class="text-xs text-slate-500 mt-1">Upload PNG, SVG, or JPG. Transparent background recommended.</p>
          <% if logo_setting&.site_logo&.attached? %>
            <div class="mt-3 p-4 bg-white rounded-lg inline-block">
              <%= image_tag logo_setting.site_logo, class: "h-12 object-contain" %>
            </div>
          <% end %>
        </div>
        
        <!-- Site Logo URL (fallback) -->
        <% site_logo_url_setting = @header_settings.find { |s| s.key == 'site_logo_url' } %>
        <% if site_logo_url_setting %>
          <div>
            <%= label_tag "settings[site_logo_url]", "OR Site Logo URL (fallback)", class: "block text-sm font-medium text-slate-300 mb-2" %>
            <%= text_field_tag "settings[site_logo_url]", site_logo_url_setting.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary", placeholder: "https://example.com/logo.png" %>
            <p class="text-xs text-slate-500 mt-1">If no image uploaded, this URL will be used</p>
          </div>
        <% end %>
        
        <!-- Other header settings -->
        <% @header_settings.reject { |s| s.key == 'site_logo_url' }.each do |setting| %>
          <div>
            <%= label_tag "settings[#{setting.key}]", setting.key.humanize.titleize, class: "block text-sm font-medium text-slate-300 mb-2" %>
            <%= text_field_tag "settings[#{setting.key}]", setting.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary", placeholder: setting.key %>
          </div>
        <% end %>
        
        <!-- Save Button -->
        <div class="pt-4 border-t border-slate-700/50">
          <%= f.submit "Save Header Settings", class: "w-full px-6 py-3 bg-primary hover:bg-blue-600 text-white font-bold rounded-lg transition-colors cursor-pointer" %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Promo Banner Section Form -->
  <%= form_with url: batch_update_admin_settings_path, method: :patch, multipart: true, class: "mb-6" do |f| %>
    <div class="bg-surface-dark rounded-xl border border-slate-700/50 overflow-hidden">
      <div class="p-6 border-b border-slate-700/50">
        <h2 class="text-lg font-bold text-white flex items-center gap-2">
          <span class="material-symbols-outlined text-primary">campaign</span>
          Promo Banner
        </h2>
      </div>
      <div class="p-6 space-y-4">
        <!-- Enable/Disable -->
        <% promo_enabled = @general_settings.find { |s| s.key == 'promo_banner_enabled' } %>
        <% if promo_enabled %>
          <div>
            <%= label_tag "settings[promo_banner_enabled]", "Enable Promo Banner", class: "block text-sm font-medium text-slate-300 mb-2" %>
            <%= select_tag "settings[promo_banner_enabled]", options_for_select([["Enabled", "true"], ["Disabled", "false"]], promo_enabled.value), class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white focus:border-primary focus:ring-1 focus:ring-primary" %>
          </div>
        <% end %>

        <!-- Background Image Upload -->
        <% promo_bg_setting = Setting.find_by(key: 'promo_banner_bg_url') %>
        <div>
          <%= label_tag :promo_bg_image, "Background Image (Upload)", class: "block text-sm font-medium text-slate-300 mb-2" %>
          <%= file_field_tag :promo_bg_image, accept: "image/*", class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-blue-600" %>
          <p class="text-xs text-slate-500 mt-1">Upload banner background image. Recommended: 1920x100px</p>
          <% if promo_bg_setting&.promo_bg_image&.attached? %>
            <div class="mt-3 rounded-lg overflow-hidden inline-block border border-slate-700">
              <%= image_tag promo_bg_setting.promo_bg_image, class: "h-16 object-cover" %>
            </div>
          <% end %>
        </div>

        <!-- Background URL (fallback) -->
        <% if promo_bg_setting %>
          <div>
            <%= label_tag "settings[promo_banner_bg_url]", "OR Background Image URL (fallback)", class: "block text-sm font-medium text-slate-300 mb-2" %>
            <%= text_field_tag "settings[promo_banner_bg_url]", promo_bg_setting.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary", placeholder: "https://example.com/banner-bg.jpg" %>
            <p class="text-xs text-slate-500 mt-1">If no image uploaded, this URL will be used</p>
          </div>
        <% end %>

        <!-- Promo Text -->
        <% promo_text = @general_settings.find { |s| s.key == 'promo_banner_text' } %>
        <% if promo_text %>
          <div>
            <%= label_tag "settings[promo_banner_text]", "Promo Text", class: "block text-sm font-medium text-slate-300 mb-2" %>
            <%= text_field_tag "settings[promo_banner_text]", promo_text.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary", placeholder: "ðŸŽ‰ LANZAMIENTO 2026" %>
          </div>
        <% end %>

        <!-- Promo Subtitle -->
        <% promo_subtitle = @general_settings.find { |s| s.key == 'promo_banner_subtitle' } %>
        <% if promo_subtitle %>
          <div>
            <%= label_tag "settings[promo_banner_subtitle]", "Promo Subtitle", class: "block text-sm font-medium text-slate-300 mb-2" %>
            <%= text_field_tag "settings[promo_banner_subtitle]", promo_subtitle.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary", placeholder: "15% OFF en todos los paquetes" %>
          </div>
        <% end %>
        
        <!-- Save Button -->
        <div class="pt-4 border-t border-slate-700/50">
          <%= f.submit "Save Promo Banner Settings", class: "w-full px-6 py-3 bg-primary hover:bg-blue-600 text-white font-bold rounded-lg transition-colors cursor-pointer" %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Hero Section Form -->
  <%= form_with url: batch_update_admin_settings_path, method: :patch, multipart: true, class: "mb-6" do |f| %>
    <div class="bg-surface-dark rounded-xl border border-slate-700/50 overflow-hidden">
      <div class="p-6 border-b border-slate-700/50">
        <h2 class="text-lg font-bold text-white flex items-center gap-2">
          <span class="material-symbols-outlined text-primary">rocket_launch</span>
          Hero Section
        </h2>
      </div>
      <div class="p-6 space-y-4">
        <!-- Background Image Upload -->
        <% hero_bg_setting = Setting.find_by(key: 'hero_bg_url') %>
        <div>
          <%= label_tag :hero_bg_image, "Hero Background Image (Upload)", class: "block text-sm font-medium text-slate-300 mb-2" %>
          <%= file_field_tag :hero_bg_image, accept: "image/*", class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-blue-600" %>
          <p class="text-xs text-slate-500 mt-1">Upload hero background image. Recommended: 1920x800px</p>
          <% if hero_bg_setting&.hero_bg_image&.attached? %>
            <div class="mt-3 rounded-lg overflow-hidden inline-block border border-slate-700">
              <%= image_tag hero_bg_setting.hero_bg_image, class: "h-24 object-cover" %>
            </div>
          <% end %>
        </div>

        <!-- Background URL (fallback) -->
        <% if hero_bg_setting %>
          <div>
            <%= label_tag "settings[hero_bg_url]", "OR Background Image URL (fallback)", class: "block text-sm font-medium text-slate-300 mb-2" %>
            <%= text_field_tag "settings[hero_bg_url]", hero_bg_setting.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary", placeholder: "https://example.com/hero-bg.jpg" %>
            <p class="text-xs text-slate-500 mt-1">If no image uploaded, this URL will be used</p>
          </div>
        <% end %>

        <!-- WhatsApp Number -->
        <% whatsapp_setting = Setting.find_by(key: 'whatsapp_number') %>
        <% if whatsapp_setting %>
          <div>
            <%= label_tag "settings[whatsapp_number]", "WhatsApp Number (for CTA button)", class: "block text-sm font-medium text-slate-300 mb-2" %>
            <%= text_field_tag "settings[whatsapp_number]", whatsapp_setting.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary", placeholder: "5493813416824" %>
            <p class="text-xs text-slate-500 mt-1">Format: Country code + area code + number (no spaces or +)</p>
          </div>
        <% end %>

        <!-- Other hero settings -->
        <% @hero_settings.reject { |s| s.key == 'hero_bg_url' }.each do |setting| %>
          <div>
            <%= label_tag "settings[#{setting.key}]", setting.key.humanize.titleize, class: "block text-sm font-medium text-slate-300 mb-2" %>
            <% if setting.key.include?('subtitle') %>
              <%= text_area_tag "settings[#{setting.key}]", setting.value, rows: 3, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary" %>
            <% else %>
              <%= text_field_tag "settings[#{setting.key}]", setting.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary" %>
            <% end %>
          </div>
        <% end %>
        
        <!-- Save Button -->
        <div class="pt-4 border-t border-slate-700/50">
          <%= f.submit "Save Hero Settings", class: "w-full px-6 py-3 bg-primary hover:bg-blue-600 text-white font-bold rounded-lg transition-colors cursor-pointer" %>
      </div>
    </div>
  <% end %>

  <!-- Services Section Form -->
  <%= form_with url: batch_update_admin_settings_path, method: :patch, class: "mb-6" do |f| %>
    <div class="bg-surface-dark rounded-xl border border-slate-700/50 overflow-hidden">
      <div class="p-6 border-b border-slate-700/50">
        <h2 class="text-lg font-bold text-white flex items-center gap-2">
          <span class="material-symbols-outlined text-primary">grid_view</span>
          Services Section
        </h2>
      </div>
      <div class="p-6 space-y-4">
        <% services_title = Setting.find_by(key: 'services_title') %>
        <% if services_title %>
          <div>
            <%= label_tag "settings[services_title]", "Section Title", class: "block text-sm font-medium text-slate-300 mb-2" %>
            <%= text_field_tag "settings[services_title]", services_title.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary", placeholder: "Our Expertise" %>
          </div>
        <% end %>
        
        <% services_subtitle = Setting.find_by(key: 'services_subtitle') %>
        <% if services_subtitle %>
          <div>
            <%= label_tag "settings[services_subtitle]", "Section Subtitle", class: "block text-sm font-medium text-slate-300 mb-2" %>
            <%= text_field_tag "settings[services_subtitle]", services_subtitle.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary", placeholder: "Specialized services for every stage of growth." %>
          </div>
        <% end %>
        
        <!-- Save Button -->
        <div class="pt-4 border-t border-slate-700/50">
          <%= f.submit "Save Services Settings", class: "w-full px-6 py-3 bg-primary hover:bg-blue-600 text-white font-bold rounded-lg transition-colors cursor-pointer" %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Footer CTA Section Form -->
  <%= form_with url: batch_update_admin_settings_path, method: :patch, class: "mb-6" do |f| %>
    <div class="bg-surface-dark rounded-xl border border-slate-700/50 overflow-hidden">
      <div class="p-6 border-b border-slate-700/50">
        <h2 class="text-lg font-bold text-white flex items-center gap-2">
          <span class="material-symbols-outlined text-primary">call_to_action</span>
          Footer CTA
        </h2>
      </div>
      <div class="p-6 space-y-4">
        <% @footer_settings.each do |setting| %>
          <div>
            <%= label_tag "settings[#{setting.key}]", setting.key.humanize.titleize, class: "block text-sm font-medium text-slate-300 mb-2" %>
            <% if setting.key.include?('subtitle') %>
              <%= text_area_tag "settings[#{setting.key}]", setting.value, rows: 2, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary" %>
            <% else %>
              <%= text_field_tag "settings[#{setting.key}]", setting.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary" %>
            <% end %>
          </div>
        <% end %>
        
        <!-- Save Button -->
        <div class="pt-4 border-t border-slate-700/50">
          <%= f.submit "Save Footer Settings", class: "w-full px-6 py-3 bg-primary hover:bg-blue-600 text-white font-bold rounded-lg transition-colors cursor-pointer" %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- General Settings Form -->
  <%= form_with url: batch_update_admin_settings_path, method: :patch, class: "mb-6" do |f| %>
    <!-- General Settings -->
    <% if @general_settings.any? %>
      <div class="bg-surface-dark rounded-xl border border-slate-700/50 overflow-hidden">
        <div class="p-6 border-b border-slate-700/50">
          <h2 class="text-lg font-bold text-white flex items-center gap-2">
            <span class="material-symbols-outlined text-primary">settings</span>
            General
          </h2>
        </div>
        <div class="p-6 space-y-4">
          <% @general_settings.each do |setting| %>
            <div>
              <%= label_tag "settings[#{setting.key}]", setting.key.humanize.titleize, class: "block text-sm font-medium text-slate-300 mb-2" %>
              <%= text_field_tag "settings[#{setting.key}]", setting.value, class: "w-full px-4 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:border-primary focus:ring-1 focus:ring-primary" %>
            </div>
          <% end %>
          
          <!-- Save Button -->
          <div class="pt-4 border-t border-slate-700/50">
            <%= f.submit "Save General Settings", class: "w-full px-6 py-3 bg-primary hover:bg-blue-600 text-white font-bold rounded-lg transition-colors cursor-pointer" %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

  <!-- Integrations Card -->
  <div class="bg-surface-dark rounded-xl border border-slate-700/50 overflow-hidden">
    <div class="p-6 border-b border-slate-700/50">
      <h2 class="text-lg font-bold text-white flex items-center gap-2">
        <span class="material-symbols-outlined text-primary">extension</span>
        Integrations
      </h2>
    </div>

    <div class="divide-y divide-slate-700/50">
      <!-- Meta / Facebook Lead Ads -->
      <div class="p-6 flex items-start justify-between">
        <div class="flex gap-4">
          <div class="w-12 h-12 rounded-lg bg-[#1877F2]/10 flex items-center justify-center text-[#1877F2]">
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
          </div>
          <div>
            <h3 class="text-white font-medium text-base">Facebook Lead Ads</h3>
            <p class="text-slate-400 text-sm mt-1">Sync leads and creatives automatically.</p>

            <% if @meta_connection %>
              <div class="mt-3 flex items-center gap-2">
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                  <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                  Connected: <%= @meta_connection.page_name %>
                </span>
              </div>
            <% end %>
          </div>
        </div>

        <div>
          <% if @meta_connection %>
            <%= button_to disconnect_meta_admin_settings_path, method: :delete, class: "px-4 py-2 text-sm font-medium text-red-400 hover:bg-red-900/20 rounded-lg transition-colors border border-transparent hover:border-red-900/30" do %>
              Disconnect
            <% end %>
          <% else %>
            <%
              app_id = Rails.application.credentials.dig(:meta, :app_id)
              redirect_uri = auth_meta_callback_url
              scope = "leads_retrieval,pages_manage_metadata,pages_read_engagement,ads_management,pages_show_list,business_management"
              oauth_url = "https://www.facebook.com/v19.0/dialog/oauth?client_id=#{app_id}&redirect_uri=#{redirect_uri}&scope=#{scope}&response_type=code"
            %>
            <a href="<%= oauth_url %>" class="flex items-center gap-2 px-4 py-2 bg-[#1877F2] hover:bg-[#1877F2]/90 text-white text-sm font-bold rounded-lg transition-colors shadow-lg shadow-blue-900/20">
              Connect Page
            </a>
          <% end %>
        </div>
      </div>

      <!-- Chatwoot -->
      <div class="p-6 flex items-start justify-between bg-slate-800/30">
        <div class="flex gap-4">
          <div class="w-12 h-12 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-400">
            <span class="material-symbols-outlined text-2xl">chat</span>
          </div>
          <div>
            <h3 class="text-white font-medium text-base">Chatwoot</h3>
            <p class="text-slate-400 text-sm mt-1">Connected CRM for conversations.</p>
             <div class="mt-3 flex items-center gap-2">
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">
                  <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                  Active
                </span>
              </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
